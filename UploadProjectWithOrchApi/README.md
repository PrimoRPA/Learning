# Инструкция по добавлению проекта через API Оркестратора

Полное описание API приведено в Swagger. Для того, чтобы открыть Swagger, воспользуйтесь документом «Руководство по открытию Swagger», который входит в комплект поставки Оркестратора. 

## Упаковка архива проекта

Упаковать проект в zip-файл можно средствами Студии или самостоятельно. Для упаковки через Студию ознакомьтесь с инструкцией из раздела [Публикация проекта](https://github.com/PrimoRPA/Docs.Rus/blob/main/primo-studio/projects/publish.md).

При архивации проекта Студия автоматически удаляет из него файлы:
* project.ltr - файл ресурсов. В нем хранятся точки останова и точки пропуска в проекте. Таким образом, для готового проекта, который будет выполняться роботом, файл *.ltr удаляется без последствий. Если же предусматривается использование проекта в отладчике, то без этого файла в нем не будет точек останова и точек пропуска.
* файлы с расширением *.bak - резервная копия процессов.
* подкаталоги *.git - служебный каталог, если используется git для хранения проекта.
* .InvokedProjects - временная папка проектов.

Самостоятельно упаковать проект можно любым подходящим архиватором. 

## Авторизация в Оркестраторе

Перед отправкой архива проекта по API пользователь должен авторизоваться в Оркестраторе. Авторизация всегда осуществляется в рамках тенанта, который содержится в JWT-токене.

Для авторизации используется **POST-запрос**: `{OrchestratorUrl}/api/account`

Запрос не имеет параметров. Тело запроса отправляется в формате json, пример структуры:

```json
{
  "userName": "string",
  "password": "string",
  "robotEdition": "1 = Enterprise"
}
```
Описание полей тела запроса приведено в таблице ниже.

***Таблица 1 – Параметры тела запроса на авторизацию***

| Параметр	| Тип	| Описание
|-----------|-----|----------
|userName	  |string	| Логин пользователя. Обязательный
|password	  | string |	Пароль пользователя. Обязательный
|robotEdition	| integer	| Издание робота. Необязательный. <p>Возможные значения:</p><p>•	1 – Enterprise;</p><p>•	2 – Standard;</p><p>•	3 - Desktop</p>


:bangbang: **ВАЖНО! Проект будет загружен в тот тенант, к которому относится авторизованный пользователь.**

 
## Добавление проекта 

Проект загружается через UI Оркестратора в несколько этапов.

###	1. Получение GUID 

Сначала нужно получить GUID транзакции.\
Для этого используем **GET-запрос**: `/api/RpaProjects/ArchiveGuid`\
Запрос не имеет параметров. Успешный ответ вернет GUID.

:green_circle: Пример успешного ответа:

`3fa85f64-5717-4562-b3fc-2c963f66afa6`

###	2. Загрузка архива проекта

Загружаем архив проекта с полученным GUID.\
**POST-запрос**: `/api/RpaProjects/archive/{id}`

Запрос имеет обязательный параметр **id** (string) - это GUID архива.\
В заголовке запроса **Content-type** необходимо указать тип содержимого `multipart/form-data`. В теле запроса, в формате form-data, требуется указать ключ **file1**, а в его значении – приложенный файл архива. 

###	3. Запрос состояния загрузки архива

Запрашиваем состояние загрузки архива через **GET-запрос**: `/api/RpaProjects/archive/{fileId}`\
Запрос имеет обязательный параметр **fileId** (string) – GUID архива проекта. Обращаем внимание, что загрузка может быть долгой.

Успешный ответ означает, что архив загрузился.\
:green_circle: Пример структуры успешного ответа:
```json
{
  "fileId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "fileSize": 0,
  "contentLength": 0,
  "uploadedAt": "2023-02-22T07:03:50.824Z"
}
```
Описание параметров ответа приведено в таблице ниже.

***Таблица 2 – Параметры ответа на запрос состояния загрузки архива***

| Параметр	| Тип	| Описание
|-----------|-----|----------
| fileId	  | string	| GUID архива проекта
| fileSize	| integer	| Фактически записанный на диск размер файла
| contentLength	| integer	| ContentLength (размер тела сообщения в байтах), передаваемый в заголовке HTTP на загрузку файла. Совместно с параметром FileSize используется для определения процента загрузки
| uploadedAt	| string	| Дата/время загрузки файла в формате строки. Проставляется после полного скачивания файла на диск

###	4. Получение процессов

Получаем список процессов, используя **GET-запрос**: 
`/api/RpaProjects/v2/Archive/{fileId}/Workflows`\
Запрос имеет обязательный параметр **fileId** (string) - GUID архива.\
В случае успеха в ответе вернется список процессов проекта. 

###	5. Отправка формы добавления проекта 

Отправляем на сервер форму добавления проекта - там она сама соединится с архивом по GUID.\
Используем **POST-запрос**: `/api/RpaProjects/v2`

Запрос имеет опциональный параметр **parentId** (integer) - он указывается, если требуется обновить ранее добавленный проект и  версию проекта.  передаем его ID в этом параметре.
Тело запроса отправляется в формате json. Пример структуры:

```json
{
  "name": "string",
  "description": "string",
  "mainWorkflow": "string",
  "softPlatform": "1 = X86",
  "runConfig": "0 = None",
  "runConfigCustom": "string",
  "mock": true,
  "durationLevel": "0 = Low",
  "robotDistrVersions": "string",
  "closeRDPSession": true,
  "exclusiveLaunch": true,
  "noDuplicateDeferredQueue": true,
  "fileId": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```
Описание параметров в теле запроса приведено в таблице ниже.
 
***Таблица 3 – Параметры в теле запроса на отправку формы***

| Параметр	| Тип	  | Описание
|-----------|-------|-----------
| name	    | string	| Наименование проекта. Обязательно для указания
| description	| string	| Описание проекта
| mainWorkflow	| string	| Имя главного процесса
| softPlatform	| integer	| Разрядность платформы. Обязательно для указания. Возможные значения: <p>•	1 - х86;</p><p>•	2 - х64</p>
| runConfig	| integer	| Конфигурация запуска. Возможные значения:<p>•	0 – отсутствует;</p><p>•	1 – отладка;</p><p>•	2 - релиз</p>
| runConfigCustom	|string	| Cпециальная конфигурация запуска
| mock	          | boolean	| Использовать заглушки. Возможные значения:<p>•	true – использовать;</p><p>•	false – без заглушек</p>
| durationLevel	| integer	| Приоритет. Определяет, как долго проект будет находиться в очереди проектов, когда туда попадет, и в каком порядке проекты будут выходить из очереди при одновременном попадании в нее. Время (сек.) нахождения проекта в очереди задается в конфигурационном файле Оркестратора. <p>Возможные значения:</p> <p>•	0 – низкий (low);</p><p>•	1 – средний (medium);</p><p>•	2 – высокий (high)</p>
| robotDistrVersions	| string	| Версии дистрибутива робота. Только роботы указанных версий дистрибутива будут считаться подходящими для выполнения проекта
| closeRDPSession	    | boolean	| После выполнения проекта роботом закрыть RDP-сессию. Если RDP-сессия в этот момент нужна для работы других роботов, она не закроется. Иногда такие сессии могут оставаться активными, когда уже нет активных роботов. Тогда закрыть сессию требуется вручную. <p>Возможные значения:</p> <p>•	true – закрыть;</p><p>•	false – не закрывать</p>
| exclusiveLaunch	| boolean	| Запускать проект в единственном экземпляре. Запуск проекта будет пропущен, если проект уже запущен в данный момент. Не распространяется на ручной запуск робота с проектом. <p>Возможные значения:</p><p>•	true – запускать в единственном экземпляре;</p><p>•	false – неактивно</p>
| noDuplicateDeferredQueue | boolean	| Не повторять в очереди проектов. Если проект уже находится в очереди ожидания, он туда не добавится повторно. <p>Возможные значения:</p><p>•	true – не повторять;</p><p>•	false – повторять в очереди</p>
| fileId	| string	| GUID архива проекта

:green_circle: В случае успеха вернется json-ответ. Пример структуры:

```json
{
  "id": 0,
  "parentId": 0,
  "name": "string",
  "description": "string",
  "mainWorkflow": "string",
  "softPlatformName": "string",
  "softPlatform": "1 = X86",
  "runConfig": "0 = None",
  "runConfigCustom": "string",
  "mock": true,
  "queueItems": [
    {
      "id": 0,
      "createdAt": "2023-02-21T11:54:31.828Z",
      "updatedAt": "2023-02-21T11:54:31.828Z"
    }
  ],
  "queueNotEmpty": true,
  "version": 0,
  "createdAt": "2023-02-21T11:54:31.828Z",
  "versions": [
    null
  ],
  "durationLevel": "0 = Low",
  "robotDistrVersions": "string",
  "existsNodeConfirms": true,
  "fileId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "closeRDPSession": true,
  "active": true,
  "hasInputVariable": true,
  "hasOutputVariable": true,
  "hasInOutputVariable": true,
  "hasNotActiveVersions": true,
  "exclusiveLaunch": true,
  "noDuplicateDeferredQueue": true
}
```


