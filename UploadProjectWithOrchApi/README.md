# Инструкция по добавлению проекта через API Оркестратора

Полное описание API приведено в Swagger. Для того, чтобы открыть Swagger, воспользуйтесь документом «Руководство по открытию Swagger», который входит в комплект поставки Оркестратора. 

## 1. Архивация проекта

Упаковать проект в zip-файл можно средствами Студии или самостоятельно. Для упаковки инструментами Студии ознакомьтесь с инструкцией [Публикация проекта](https://github.com/PrimoRPA/Docs.Rus/blob/main/primo-studio/projects/publish.md).

При архивации проекта Студия автоматически удаляет файлы:
* project.ltr - файл ресурсов. В нем хранятся точки останова и точки пропуска в проекте. Таким образом, для готового проекта, который будет выполняться роботом, файл \*.ltr удаляется без последствий. Если же предусматривается использование проекта в отладчике, то без этого файла в нем не будет точек останова и точек пропуска;
* файлы с расширением \*.bak - резервная копия процессов;
* подкаталоги \*.git - служебный каталог, если используется git для хранения проекта;
* .InvokedProjects - временная папка проектов.

Самостоятельно упаковать проект можно любым подходящим архиватором. Лишние файлы из проекта также необходимо удалить вручную.

## 2. Авторизация в Оркестраторе

Перед отправкой архива проекта по API пользователь должен авторизоваться в Оркестраторе. Авторизация всегда осуществляется в рамках тенанта пользователя, который содержится в JWT-токене.

Для авторизации используется **POST-запрос**: `{OrchestratorUrl}/api/account`

Запрос не имеет параметров. Тело запроса отправляется в формате json, пример структуры:

```json
{
  "userName": "string",
  "password": "string",
  "robotEdition": "1 = Enterprise"
}
```
Описание полей тела запроса приведено в таблице ниже.

***Таблица 1 – Параметры тела запроса на авторизацию***

| Параметр	| Тип	| Описание
|-----------|-----|----------
|userName	  |string	| Логин пользователя. Обязательный
|password	  | string |	Пароль пользователя. Обязательный
|robotEdition	| integer	| Издание робота. Необязательный. <p>Возможные значения:</p><p>•	1 – Enterprise;</p><p>•	2 – Standard;</p><p>•	3 - Desktop</p>


:bangbang: **ВАЖНО! Проект будет загружен в тот тенант, к которому относится авторизованный пользователь.**

 
## 3. Добавление проекта 

Проект загружается через UI Оркестратора в несколько этапов.

###	3.1. Получение GUID 

Сначала нужно получить GUID транзакции.\
Для этого используем **GET-запрос**: `/api/RpaProjects/ArchiveGuid`\
Запрос не имеет параметров. Успешный ответ вернет GUID.

:green_circle: Пример успешного ответа:

`3fa85f64-5717-4562-b3fc-2c963f66afa6`

###	3.2. Загрузка архива проекта

Загружаем архив проекта с полученным GUID.\
Используем **POST-запрос**: `/api/RpaProjects/archive/{id}`

Запрос имеет обязательный параметр **id** (string) - это GUID архива.\
В заголовке запроса **Content-type** необходимо указать тип содержимого `multipart/form-data`. В теле запроса, в формате form-data, требуется указать ключ **file1**, а в его значении – приложенный файл архива. 

###	3.3. Запрос состояния загрузки архива

Запрашиваем состояние загрузки архива через **GET-запрос**: `/api/RpaProjects/archive/{fileId}`\
Запрос имеет обязательный параметр **fileId** (string) – GUID архива проекта. Обращаем внимание, что загрузка может быть долгой.

Успешный ответ означает, что архив загрузился.\
:green_circle: Пример структуры успешного ответа:
```json
{
  "fileId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "fileSize": 0,
  "contentLength": 0,
  "uploadedAt": "2023-02-22T07:03:50.824Z"
}
```
Описание параметров ответа приведено в таблице ниже.

***Таблица 2 – Параметры ответа на запрос состояния загрузки архива***

| Параметр	| Тип	| Описание
|-----------|-----|----------
| fileId	  | string	| GUID архива проекта
| fileSize	| integer	| Фактически записанный на диск размер файла
| contentLength	| integer	| ContentLength (размер тела сообщения в байтах), передаваемый в заголовке HTTP на загрузку файла. Совместно с параметром FileSize используется для определения процента загрузки
| uploadedAt	| string	| Дата/время загрузки файла в формате строки. Проставляется после полного скачивания файла на диск. Может быть null

###	3.4. Получение процессов

Получаем список процессов, используя **GET-запрос**: 
`/api/RpaProjects/v2/Archive/{fileId}/Workflows`\
Запрос имеет обязательный параметр **fileId** (string) - GUID архива.\
В случае успеха в ответе вернется список процессов проекта. 

###	3.5. Отправка формы добавления проекта 

Отправляем на сервер форму добавления проекта - там она сама соединится с архивом по GUID.\
Используем **POST-запрос**: `/api/RpaProjects/v2`

Запрос имеет опциональный параметр **parentId** (integer). Он используется только при обновлении уже загруженного проекта. Например, если в проект внесли изменения, после чего потребовалось загрузить в Оркестратор его новую версию, то в запросе указываем данный атрибут, чтобы связать новую версию с родительской. Значение параметра **parentId** - это id из ответа на запрос `/api/RpaProjects/v2`. К примеру, при первой загрузке проекта в Оркестратор мы получили в ответе id со значением 123 и сохранили его. Тогда запрос на обновление будет таким: `/api/RpaProjects/v2?parentId=123`

Тело запроса отправляется в формате json. Пример структуры:

```json
{
  "name": "string",
  "description": "string",
  "mainWorkflow": "string",
  "softPlatform": "1 = X86",
  "runConfig": "0 = None",
  "runConfigCustom": "string",
  "mock": true,
  "durationLevel": "0 = Low",
  "robotDistrVersions": "string",
  "closeRDPSession": true,
  "exclusiveLaunch": true,
  "noDuplicateDeferredQueue": true,
  "fileId": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```
Описание параметров в теле запроса приведено в таблице ниже.
 
***Таблица 3 – Параметры в теле запроса на отправку формы***

| Параметр	| Тип	  | Описание
|-----------|-------|-----------
| name	    | string	| Наименование проекта
| description	| string	| Описание проекта. Может быть null
| mainWorkflow	| string	| Имя главного процесса. Может быть null
| softPlatform	| integer	| Разрядность платформы. Обязательно для указания. Возможные значения: <p>•	1 - х86;</p><p>•	2 - х64</p>
| runConfig	| integer	| Конфигурация запуска проекта. Возможные значения:<p>•	0 – отсутствует;</p><p>•	1 – отладка;</p><p>•	2 - релиз</p>
| runConfigCustom	|string	| Cпециальная конфигурация запуска. Может быть null
| mock	          | boolean	| Использовать заглушки. Возможные значения:<p>•	true – использовать;</p><p>•	false – без заглушек</p>
| durationLevel	| integer	| Приоритет. Определяет, как долго проект будет находиться в очереди проектов, когда туда попадет, и в каком порядке проекты будут выходить из очереди при одновременном попадании в нее. Время (сек.) нахождения проекта в очереди задается в конфигурационном файле Оркестратора. <p>Возможные значения:</p> <p>•	0 – низкий (low);</p><p>•	1 – средний (medium);</p><p>•	2 – высокий (high)</p>
| robotDistrVersions	| string	| Версии дистрибутива робота. Только роботы указанных версий дистрибутива будут считаться подходящими для выполнения проекта. Может быть null
| closeRDPSession	    | boolean	| После выполнения проекта роботом закрыть RDP-сессию. Если RDP-сессия в этот момент нужна для работы других роботов, она не закроется. Иногда такие сессии могут оставаться активными, когда уже нет активных роботов. Тогда закрыть сессию требуется вручную. <p>Возможные значения:</p> <p>•	true – закрыть;</p><p>•	false – не закрывать</p>
| exclusiveLaunch	| boolean	| Запускать проект в единственном экземпляре. Запуск проекта будет пропущен, если проект уже запущен в данный момент. Не распространяется на ручной запуск робота с проектом. <p>Возможные значения:</p><p>•	true – запускать в единственном экземпляре;</p><p>•	false – неактивно</p>
| noDuplicateDeferredQueue | boolean	| Не повторять в очереди проектов. Если проект уже находится в очереди ожидания, он туда не добавится повторно. <p>Возможные значения:</p><p>•	true – не повторять;</p><p>•	false – повторять в очереди</p>
| fileId	| string	| GUID архива проекта

:green_circle: В случае успеха вернется json-ответ. Пример структуры:

```json
{
  "id": 0,
  "parentId": 0,
  "name": "string",
  "description": "string",
  "mainWorkflow": "string",
  "softPlatformName": "string",
  "softPlatform": "1 = X86",
  "runConfig": "0 = None",
  "runConfigCustom": "string",
  "mock": true,
  "queueItems": [
    {
      "id": 0,
      "createdAt": "2023-02-21T11:54:31.828Z",
      "updatedAt": "2023-02-21T11:54:31.828Z"
    }
  ],
  "queueNotEmpty": true,
  "version": 0,
  "createdAt": "2023-02-21T11:54:31.828Z",
  "versions": [
    null
  ],
  "durationLevel": "0 = Low",
  "robotDistrVersions": "string",
  "existsNodeConfirms": true,
  "fileId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "closeRDPSession": true,
  "active": true,
  "hasInputVariable": true,
  "hasOutputVariable": true,
  "hasInOutputVariable": true,
  "hasNotActiveVersions": true,
  "exclusiveLaunch": true,
  "noDuplicateDeferredQueue": true
}
```
***Таблица 4 – Параметры ответа***
| Параметр  | Тип    | Описание
|-----------|-------|-----------
| id        | integer | Уникальный идентификатор записи
| parentId  | integer | В значении может быть null
| name      | string  | Наименование проекта. Может быть null
| description | string | Описание проекта. Может быть null
| mainWorkflow | string | Имя файла главного процесса. Может быть null
| softPlatformName | string | Имя программной платформы. Может быть null
| softPlatform | integer | Разрядность платформы. <p>Возможные значения:</p> <p>•	1 - х86;</p><p>•	2 - х64</p>
| runConfig   | integer  | Конфигурация запуска проекта. Возможные значения:<p>• 0 – отсутствует;</p><p>•	1 – отладка;</p><p>• 2 - релиз</p>
| runConfigCustom | string | Специальная конфигурация запуска проекта. Может быть null
| mock      | boolean  |  Признак использования заглушек. Возможные значения:<p>•	true – используются;</p><p>•	false – без заглушек</p>
| queueItems |       | Очередь выполнения проекта. Может быть null. <p>Параметры объекта:</p><p>• id - уникальный идентификатор очереди (integer);</p><p>• createdAt - дата и время создания (string);</p><p>• updatedAt - дата и время обновления (string). Может быть null</p>
| queueNotEmpty |	boolean | Очередь выполнения не пустая
| version   | integer | Номер версии
| createdAt | string  | Дата и время (в формате строки) создания записи на сервере 
| versions  |       | Используется до версии 2.2.17.0 Далее версии извлекаются отдельным запросом. Может быть null 
| durationLevel | integer | Приоритет проекта в очереди ожидания на выполнение. Определяет, как долго проект будет находиться в очереди проектов, если туда попадет, и в каком порядке проекты будут выходить из очереди при одновременном добавлении в нее. <p>Возможные значения:</p> <p>•	0 – низкий (low);</p><p>•	1 – средний (medium);</p><p>•	2 – высокий (high)</p>
| robotDistrVersions | string | Список версий дистрибутивов через запятую. Если задан, то роботы только с этими версиями дистрибутива смогут выполнять проект. Может быть null 
| existsNodeConfirms | boolean | Дистрибутив физически присутствует (реплицирован) на всех нодах (узлах). Может быть null 
| fileId    | string | GUID файла проекта. Может быть null 
| closeRDPSession | boolean | После выполнения проекта роботом закрыть RDP-сессию. <p>Возможные значения:</p> <p>•	true – закрыть;</p><p>•	false – не закрывать</p>
| active  | boolean |
| hasInputVariable | boolean | Проект имеет входную переменную
| hasOutputVariable |  boolean | Проект имеет выходную переменную
| hasInOutputVariable | boolean |
| hasNotActiveVersions | boolean | Проект имеет неактивные версии
| exclusiveLaunch | boolean | Проект запускается в единственном экземпляре. <p>Возможные значения:</p><p>•	true – запускается в единственном экземпляре;</p><p>•	false – параметр не включен</p>
| noDuplicateDeferredQueue | boolean | Не повторять проект в очереди ожидания. <p>Возможные значения:</p><p>•	true – не повторять в очереди;</p><p>•	false – повторять</p>


## Пример реализации

Добавить архив описанным способом можно как через стороннее приложение (например, Postman), так и написав сценарий в Студии.

Если вы хотите реализовать запросы через Студию, ознакомьтесь подробнее с учебным проектом **UploadProjectWithOrchApi**. Он содержит пример кода для всех шагов инструкции, кроме шага 1 - архивации проекта. В проекте используется последовательность из готовых элементов Студии. 

Структура учебного проекта:

1. В папке **Orch API** находятся процессы, реализующие сами запросы. Запросы к API выполняются с помощью готового элемента [**Запрос WEB-сервиса**](https://docs.primo-rpa.ru/primo-rpa/g_elements/osnovnye-elementy/els_network/el_webrequest). Исключение составляет процесс **Send Project to Server.ltw**, где отправка проекта на сервер (шаг 3.2) реализована в виде чистого кода в элементе [**C# Script**](https://docs.primo-rpa.ru/primo-rpa/g_elements/osnovnye-elementy/els_prog/el_prog_cs). Это сделано потому, что элемент **Запрос WEB-сервиса** не поддерживает запросы с типом содержимого `multipart/form-data`.
2. Папка **Data** содержит пример архива проекта для отправки в Оркестратор.
3. В процессе **UploadProject.ltw** можно просмотреть примеры значений, присвоенные переменным проекта. Например, в элементе под номером 1.3 задан относительный путь до архива проекта (в папке **Data**). А элемент под номером 1.4 содержит пример значений для параметров проекта [на шаге 3.5](https://github.com/PrimoRPA/Learning/tree/master/UploadProjectWithOrchApi#35-%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0-%D1%84%D0%BE%D1%80%D0%BC%D1%8B-%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0) (отправке формы на сервер).


